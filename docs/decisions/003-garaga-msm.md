# ADR-003: Garaga for MSM Operations

## Status

Accepted (2025-12-04)

## Context

On-chain verification of DLEQ proofs requires multiple scalar multiplications (MSM) on Ed25519. Options considered:

1. **Custom MSM implementation**: Implement scalar multiplication from scratch
2. **Garaga library**: Use audited MSM library for Starknet
3. **Manual point arithmetic**: Implement point operations manually

## Decision

Use Garaga version 1.0.1 for all MSM operations.

## Rationale

### Security

- Garaga has been audited
- No custom cryptographic implementations
- Industry-standard library for Starknet

### Functionality

- Provides `msm_g1` function for scalar multiplication
- Supports Ed25519 curve (curve_index=4)
- Handles point validation and decompression

### Efficiency

- Optimized MSM implementation
- Fake-GLV hints for gas optimization
- Well-tested and production-ready

### Maintainability

- Standard library reduces maintenance burden
- Updates and fixes handled by library maintainers
- Clear API and documentation

## Consequences

### Positive

- No custom crypto code to review
- Proven, tested implementation
- Gas-efficient operations
- Clear separation of concerns

### Negative

- Requires fake-GLV hints (generated by Python tools)
- Slight complexity in hint generation
- External dependency (managed via Scarb)

### Neutral

- Performance acceptable for use case
- Gas costs within acceptable range

## Alternatives Considered

### Custom MSM Implementation

**Rejected** because:
- High risk of bugs
- Requires extensive testing and review
- Violates "no custom crypto" principle
- Significant development time

### Manual Point Arithmetic

**Rejected** because:
- Even higher risk than custom MSM
- Would require implementing full elliptic curve operations
- No security benefit
- Massive development effort

## Implementation Notes

Garaga's `msm_g1` function requires:
- Base point (Ed25519 generator `G` or second generator `Y`)
- Scalar (u256 format)
- Fake-GLV hint (10 felts: Q.x[4], Q.y[4], s1, s2_encoded)

The hint must match the actual result point for verification to succeed. Hints are generated using Python tools that use Garaga's exact decompression format.

## Usage Pattern

```cairo
use garaga::ec_ops::msm_g1;
use garaga::definitions::G1Point;

let result: G1Point = msm_g1(
    base_point,
    scalar,
    fake_glv_hint
)?;
```

## References

- Garaga repository: https://github.com/keep-starknet-strange/garaga
- Garaga documentation: See Garaga README
- MSM hint generation: `tools/hints/generate_msm_hints.py`

---

**Author**: Development Team  
**Date**: 2025-12-04  
**Status**: Accepted

